# å¤šå‘¨æœŸæƒé‡å‚æ•°ä¼˜åŒ– - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ä¸€ã€æ¦‚è¿°

æœ¬æ–¹æ¡ˆé€šè¿‡**å†å²å›æµ‹ + å‚æ•°æœç´¢**çš„æ–¹å¼ï¼Œæ‰¾åˆ°1-20å¤©å„å‘¨æœŸæ¶¨å¹…çš„æœ€ä¼˜æƒé‡ç»„åˆã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€å¤æ‚AIæ¨¡å‹ï¼Œç®€å•ç›´æ¥
- âœ… å…¨è‡ªåŠ¨æœç´¢ï¼Œæ— éœ€äººå·¥è°ƒå‚
- âœ… 7å¤©å†…å®ŒæˆéªŒè¯
- âœ… ç»“æœå¯è§£é‡Šã€å¯å¤ç°

---

## äºŒã€æ–‡ä»¶è¯´æ˜

### æ–°å¢æ–‡ä»¶
```
project/
â”œâ”€â”€ optimization/               # ã€æ–°å¢ã€‘ä¼˜åŒ–æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ backtest_adapter.py    # å›æµ‹é€‚é…å™¨ï¼ˆæ”¯æŒåŠ¨æ€æƒé‡ï¼‰
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ quick_weight_search.py # ã€æ–°å¢ã€‘å¿«é€Ÿæƒé‡æœç´¢è„šæœ¬
â”œâ”€â”€ å¤šå‘¨æœŸæƒé‡å‚æ•°ä¼˜åŒ–æ–¹æ¡ˆ.md    # ã€æ–°å¢ã€‘è¯¦ç»†æŠ€æœ¯æ–¹æ¡ˆ
â””â”€â”€ å¿«é€Ÿå¼€å§‹æŒ‡å—.md             # ã€æ–°å¢ã€‘æœ¬æ–‡æ¡£
```

### æ ¸å¿ƒæ¨¡å—è¯´æ˜

**optimization/backtest_adapter.py**
- ä½œç”¨ï¼šå°†è‡ªå®šä¹‰æƒé‡æ³¨å…¥åˆ°ç°æœ‰å›æµ‹ç³»ç»Ÿ
- åŠŸèƒ½ï¼šä¸´æ—¶ä¿®æ”¹ `core/signal.py` ä¸­çš„æƒé‡å‚æ•°ï¼Œå›æµ‹åè‡ªåŠ¨æ¢å¤
- æ¥å£ï¼š`run_backtest_with_weights(weights, start_date, end_date)`

**scripts/quick_weight_search.py**
- ä½œç”¨ï¼šå¿«é€ŸéªŒè¯å‚æ•°ä¼˜åŒ–æ€è·¯
- æ–¹æ³•ï¼šç½‘æ ¼æœç´¢ï¼ˆä»…ä¼˜åŒ–3ä¸ªæ ¸å¿ƒå‘¨æœŸï¼š1æ—¥ã€5æ—¥ã€20æ—¥ï¼‰
- æ—¶é—´ï¼šçº¦1-2å°æ—¶ï¼ˆ7^3 = 343æ¬¡å›æµ‹ï¼‰

---

## ä¸‰ã€å¿«é€ŸéªŒè¯ï¼ˆç«‹å³å¯åšï¼‰

### æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–

```bash
pip install optuna pandas matplotlib
```

### æ­¥éª¤2ï¼šè¿è¡Œå¿«é€Ÿæœç´¢

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
python scripts/quick_weight_search.py
```

### æ­¥éª¤3ï¼šæŸ¥çœ‹ç»“æœ

è„šæœ¬ä¼šè¾“å‡ºï¼š
```
====================================================================
æœç´¢å®Œæˆï¼æœ€ä¼˜ç»“æœï¼š
====================================================================

ğŸ“Œ æœ€ä¼˜æƒé‡å‚æ•°:
  1æ—¥æ¶¨å¹…æƒé‡:     50
  5æ—¥æ¶¨å¹…æƒé‡:      0
  20æ—¥æ¶¨å¹…æƒé‡:   200

ğŸ“Š æ€§èƒ½æŒ‡æ ‡:
  èƒœç‡:       72.5%
  è¶…é¢æ”¶ç›Š:   6.3%
  æœ€å¤§å›æ’¤:   11.2%
  å¤æ™®æ¯”ç‡:   1.85
  ç»¼åˆå¾—åˆ†:   12.5

ğŸ’¾ è¯¦ç»†ç»“æœå·²ä¿å­˜è‡³: output/quick_search_results.csv

====================================================================
ä¸å½“å‰ç­–ç•¥å¯¹æ¯”:
====================================================================
            å½“å‰ç­–ç•¥    ä¼˜åŒ–ç­–ç•¥  æ”¹è¿›å¹…åº¦(%)
èƒœç‡         0.60      0.725      20.83
è¶…é¢æ”¶ç›Š     0.035     0.063      80.00
å¤æ™®æ¯”ç‡     1.2       1.85       54.17
æœ€å¤§å›æ’¤     0.14      0.112     -20.00
```

---

## å››ã€é‡è¦æç¤ºï¼šé›†æˆçœŸå®å›æµ‹ç³»ç»Ÿ

### å½“å‰çŠ¶æ€

`optimization/backtest_adapter.py` ä¸­çš„ `run_backtest_with_weights` å‡½æ•°**ç›®å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®**ï¼š

```python
def run_backtest_with_weights(weights, start_date, end_date):
    # âš ï¸ å½“å‰æ˜¯æ¨¡æ‹Ÿå®ç°
    logger.warning("âš ï¸ Using simulated backtest results!")
    result = simulate_backtest(weights, start_date, end_date)
    return result
```

### æ›¿æ¢ä¸ºçœŸå®å›æµ‹çš„3ç§æ–¹æ³•

#### æ–¹æ³•1ï¼šä½¿ç”¨æ˜é‡‘APIç›´æ¥å›æµ‹ï¼ˆæ¨èï¼‰

```python
def run_backtest_with_weights(weights, start_date, end_date):
    """ä½¿ç”¨æ˜é‡‘APIè¿è¡Œå›æµ‹"""
    from gm.api import set_token, run
    from config import config
    from main import init, algo, on_bar

    # æ³¨å…¥æƒé‡
    with BacktestAdapter() as adapter:
        adapter.inject_weights(weights)

        # è¿è¡Œå›æµ‹
        set_token(config.GM_TOKEN)

        context = run(
            strategy_id=config.STRATEGY_ID,
            filename='main.py',
            mode=MODE_BACKTEST,
            token=config.GM_TOKEN,
            backtest_start_time=start_date + ' 09:00:00',
            backtest_end_time=end_date + ' 16:00:00',
            backtest_initial_cash=10000000,
            backtest_commission_ratio=0.0001,
            backtest_slippage_ratio=0.0001
        )

        # æå–å›æµ‹ç»“æœ
        indicator = context.get('indicator', {})

        return {
            'metrics': {
                'win_rate': calculate_win_rate(context),
                'excess_return': indicator.get('pnl_ratio', 0),
                'max_drawdown': indicator.get('max_drawdown', 0),
                'sharpe_ratio': indicator.get('sharp_ratio', 0)
            }
        }
```

#### æ–¹æ³•2ï¼šè°ƒç”¨ç°æœ‰å›æµ‹è„šæœ¬

```python
import subprocess
import json

def run_backtest_with_weights(weights, start_date, end_date):
    """é€šè¿‡subprocessè°ƒç”¨run_backtest.py"""

    # æ³¨å…¥æƒé‡
    with BacktestAdapter() as adapter:
        adapter.inject_weights(weights)

        # è¿è¡Œå›æµ‹è„šæœ¬
        result = subprocess.run(
            ['python', 'run_backtest.py'],
            capture_output=True,
            text=True
        )

        # è§£æè¾“å‡ºï¼ˆéœ€è¦ä¿®æ”¹run_backtest.pyè¾“å‡ºJSONï¼‰
        output = result.stdout
        metrics = parse_backtest_output(output)

        return {
            'metrics': metrics
        }
```

#### æ–¹æ³•3ï¼šç›´æ¥è°ƒç”¨ç­–ç•¥æ¨¡å—

```python
from main import create_context, run_strategy

def run_backtest_with_weights(weights, start_date, end_date):
    """ç›´æ¥è°ƒç”¨ç­–ç•¥æ¨¡å—"""

    with BacktestAdapter() as adapter:
        adapter.inject_weights(weights)

        # åˆ›å»ºå›æµ‹ä¸Šä¸‹æ–‡
        context = create_context(
            mode='BACKTEST',
            start_date=start_date,
            end_date=end_date
        )

        # è¿è¡Œç­–ç•¥
        result = run_strategy(context)

        return {
            'metrics': extract_metrics(result)
        }
```

### éœ€è¦å®ç°çš„è¾…åŠ©å‡½æ•°

```python
def calculate_win_rate(context):
    """
    è®¡ç®—èƒœç‡ï¼šé€‰ä¸­çš„è‚¡ç¥¨è·‘èµ¢æŒ‡æ•°çš„æ¯”ä¾‹

    Args:
        context: å›æµ‹ä¸Šä¸‹æ–‡

    Returns:
        float: èƒœç‡ï¼ˆ0-1ä¹‹é—´ï¼‰
    """
    # TODO: æ ¹æ®ä½ çš„å›æµ‹ç³»ç»Ÿå®ç°
    # ä¼ªä»£ç ï¼š
    # total_picks = len(context.all_picks)
    # wins = sum(1 for pick in context.all_picks if pick.return > benchmark_return)
    # return wins / total_picks

    pass


def parse_backtest_output(output_text):
    """
    è§£æå›æµ‹è„šæœ¬çš„è¾“å‡ºæ–‡æœ¬

    Args:
        output_text: å›æµ‹è„šæœ¬çš„stdout

    Returns:
        dict: {'win_rate': ..., 'excess_return': ..., 'max_drawdown': ..., 'sharpe_ratio': ...}
    """
    # TODO: æ ¹æ®ä½ çš„å›æµ‹è¾“å‡ºæ ¼å¼è§£æ
    # ç¤ºä¾‹ï¼š
    # import re
    # win_rate = float(re.search(r'Win Rate: ([\d.]+)%', output_text).group(1)) / 100
    # ...

    pass
```

---

## äº”ã€å®Œæ•´ä¼˜åŒ–æµç¨‹ï¼ˆ7å¤©è®¡åˆ’ï¼‰

### Day 1ï¼šé›†æˆçœŸå®å›æµ‹

**ä»»åŠ¡**ï¼š
1. åœ¨ `optimization/backtest_adapter.py` ä¸­å®ç°çœŸå®å›æµ‹
2. æµ‹è¯•å•æ¬¡å›æµ‹æ˜¯å¦æ­£å¸¸

**éªŒè¯**ï¼š
```python
# æµ‹è¯•è„šæœ¬
from optimization.backtest_adapter import run_backtest_with_weights

weights = {1: 30, 3: -70, 20: 150}  # å½“å‰ç­–ç•¥æƒé‡
result = run_backtest_with_weights(weights, '2023-01-01', '2023-12-31')

print(result)
# é¢„æœŸè¾“å‡ºï¼š
# {
#     'metrics': {
#         'win_rate': 0.60,
#         'excess_return': 0.035,
#         'max_drawdown': 0.14,
#         'sharpe_ratio': 1.2
#     }
# }
```

---

### Day 2ï¼šè¿è¡Œå¿«é€Ÿæœç´¢

**ä»»åŠ¡**ï¼š
```bash
python scripts/quick_weight_search.py
```

**é¢„æœŸç»“æœ**ï¼š
- æ‰¾åˆ°3ä¸ªæ ¸å¿ƒå‘¨æœŸçš„æœ€ä¼˜æƒé‡
- éªŒè¯æ˜¯å¦èƒ½è¾¾åˆ°èƒœç‡ â‰¥ 65%

---

### Day 3-4ï¼šå…¨é¢ä¼˜åŒ–ï¼ˆ20ä¸ªå‘¨æœŸï¼‰

**ä»»åŠ¡**ï¼š
1. å®‰è£…Optunaï¼š`pip install optuna`
2. åˆ›å»ºå…¨é¢ä¼˜åŒ–è„šæœ¬ï¼š

```python
# scripts/full_optimization.py
import optuna
from optimization.backtest_adapter import run_backtest_with_weights

def objective(trial):
    # ç”Ÿæˆ20ä¸ªæƒé‡å‚æ•°
    weights = {
        i: trial.suggest_float(f'w_{i}', -200, 200, step=10)
        for i in range(1, 21)
    }

    # å›æµ‹
    result = run_backtest_with_weights(weights, '2020-01-01', '2023-12-31')
    metrics = result['metrics']

    # ç¡¬çº¦æŸ
    if metrics['win_rate'] < 0.70:
        return -1000

    # ä¼˜åŒ–ç›®æ ‡
    return metrics['excess_return'] * 100

# è¿è¡Œä¼˜åŒ–
study = optuna.create_study(direction='maximize')
study.optimize(objective, n_trials=200, n_jobs=4)

print("æœ€ä¼˜æƒé‡:")
print(study.best_params)
```

è¿è¡Œï¼š
```bash
python scripts/full_optimization.py
```

---

### Day 5ï¼šéªŒè¯æµ‹è¯•

**è®­ç»ƒé›†/æµ‹è¯•é›†åˆ†ç¦»**ï¼š

```python
# è®­ç»ƒé›†ä¼˜åŒ–ï¼ˆ2020-2022ï¼‰
train_result = run_backtest_with_weights(best_weights, '2020-01-01', '2022-12-31')

# æµ‹è¯•é›†éªŒè¯ï¼ˆ2023-2024ï¼‰
test_result = run_backtest_with_weights(best_weights, '2023-01-01', '2024-12-31')

# å¯¹æ¯”
print(f"è®­ç»ƒé›†èƒœç‡: {train_result['metrics']['win_rate']:.2%}")
print(f"æµ‹è¯•é›†èƒœç‡: {test_result['metrics']['win_rate']:.2%}")

# åˆ¤æ–­è¿‡æ‹Ÿåˆ
if test_result['metrics']['win_rate'] < train_result['metrics']['win_rate'] * 0.9:
    print("âš ï¸ å¯èƒ½å­˜åœ¨è¿‡æ‹Ÿåˆï¼")
```

---

### Day 6ï¼šå¯¹æ¯”å½“å‰ç­–ç•¥

```python
# å½“å‰ç­–ç•¥
current_weights = {1: 30, 3: -70, 20: 150}
current_result = run_backtest_with_weights(current_weights, '2023-01-01', '2024-12-31')

# ä¼˜åŒ–ç­–ç•¥
optimal_result = run_backtest_with_weights(best_weights, '2023-01-01', '2024-12-31')

# ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
generate_comparison_report(current_result, optimal_result)
```

---

### Day 7ï¼šé›†æˆåˆ°ç”Ÿäº§ç³»ç»Ÿ

**ä¿®æ”¹ `config.py`**ï¼š

```python
# æ–°å¢é…ç½®
USE_OPTIMIZED_WEIGHTS = True
OPTIMIZED_WEIGHTS = {
    1: 50,
    2: 20,
    3: -40,
    # ... ä¼˜åŒ–å¾—åˆ°çš„æƒé‡
    20: 180
}
```

**ä¿®æ”¹ `core/signal.py`**ï¼š

```python
def get_ranking(context, current_dt):
    # ...

    # ä½¿ç”¨é…ç½®ä¸­çš„æƒé‡
    from config import config
    if config.USE_OPTIMIZED_WEIGHTS:
        periods = config.OPTIMIZED_WEIGHTS
    else:
        periods = {1: 30, 3: -70, 20: 150}  # åŸæœ‰æƒé‡

    # ...
```

---

## å…­ã€å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆå¿«é€Ÿæœç´¢åªä¼˜åŒ–3ä¸ªå‘¨æœŸï¼Ÿ

**ç­”**ï¼š7^3 = 343ç§ç»„åˆï¼Œ1-2å°æ—¶å°±èƒ½è·‘å®Œï¼Œé€‚åˆå¿«é€ŸéªŒè¯æ€è·¯ã€‚å¦‚æœç›´æ¥ä¼˜åŒ–20ä¸ªå‘¨æœŸï¼Œå³ä½¿ç”¨è´å¶æ–¯ä¼˜åŒ–ä¹Ÿéœ€è¦æ•°å¤©ã€‚å…ˆéªŒè¯3ä¸ªå‘¨æœŸæœ‰æ•ˆï¼Œå†æ‰©å±•åˆ°20ä¸ªã€‚

### Q2ï¼šå¦‚ä½•åˆ¤æ–­ä¼˜åŒ–ç»“æœæ˜¯å¦è¿‡æ‹Ÿåˆï¼Ÿ

**ç­”**ï¼š3ä¸ªæ ‡å‡†ï¼š
1. è®­ç»ƒé›†/æµ‹è¯•é›†æ€§èƒ½å·®è· < 10%
2. æ»šåŠ¨çª—å£éªŒè¯ï¼ˆæ¯6ä¸ªæœˆé‡æ–°ä¼˜åŒ–ä¸€æ¬¡ï¼‰
3. æƒé‡åˆç†æ€§æ£€æŸ¥ï¼ˆå¦‚20æ—¥æƒé‡ > 1æ—¥æƒé‡ï¼‰

### Q3ï¼šä¼˜åŒ–å‡ºçš„æƒé‡èƒ½ç›´æ¥ç”¨äºå®ç›˜å—ï¼Ÿ

**ç­”**ï¼šå»ºè®®å…ˆA/Bæµ‹è¯•ï¼š
- 70%èµ„é‡‘ä½¿ç”¨ä¼˜åŒ–æƒé‡
- 30%èµ„é‡‘ä½¿ç”¨åŸæœ‰æƒé‡
- è§‚å¯Ÿ7-14å¤©ï¼Œç¡®è®¤æ•ˆæœä¼˜äºåŸç­–ç•¥å†å…¨é¢æ¨å¹¿

### Q4ï¼šå¤šä¹…éœ€è¦é‡æ–°ä¼˜åŒ–ä¸€æ¬¡ï¼Ÿ

**ç­”**ï¼š
- å®šæœŸï¼šæ¯å­£åº¦ï¼ˆ90å¤©ï¼‰
- è§¦å‘å¼ï¼šå½“å®ç›˜èƒœç‡è¿ç»­7å¤© < 60%æ—¶

---

## ä¸ƒã€è¿›é˜¶æ‰©å±•

### 1. åŠ¨æ€æƒé‡ï¼ˆæ ¹æ®å¸‚åœºçŠ¶æ€ï¼‰

```python
bull_market_weights = optimize_for_bull_market()
bear_market_weights = optimize_for_bear_market()

# å®ç›˜æ ¹æ®å¸‚åœºçŠ¶æ€åˆ‡æ¢
if market_regime == 'BULL':
    weights = bull_market_weights
else:
    weights = bear_market_weights
```

### 2. å¤šç›®æ ‡ä¼˜åŒ–

```python
study = optuna.create_study(
    directions=['maximize', 'minimize']  # [æ”¶ç›Š, å›æ’¤]
)
```

### 3. é›†æˆåˆ°Webç•Œé¢

```python
# æä¾›APIæ¥å£
@app.route('/optimize', methods=['POST'])
def optimize_weights():
    params = request.json
    result = run_optimization(params)
    return jsonify(result)
```

---

## å…«ã€æŠ€æœ¯æ”¯æŒ

### é‡åˆ°é—®é¢˜ï¼Ÿ

1. **å›æµ‹é›†æˆé—®é¢˜**ï¼šæŸ¥çœ‹ `optimization/backtest_adapter.py` ä¸­çš„TODOæ³¨é‡Š
2. **æ€§èƒ½é—®é¢˜**ï¼šä½¿ç”¨ `n_jobs=4` å¼€å¯å¤šè¿›ç¨‹å¹¶è¡Œ
3. **ç»“æœä¸ç†æƒ³**ï¼šæ£€æŸ¥æ•°æ®è´¨é‡ã€æ”¾å®½çº¦æŸæ¡ä»¶

### éœ€è¦å¸®åŠ©ï¼Ÿ

1. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š`å¤šå‘¨æœŸæƒé‡å‚æ•°ä¼˜åŒ–æ–¹æ¡ˆ.md`
2. æŸ¥çœ‹ä»£ç æ³¨é‡Šï¼šæ‰€æœ‰å‡½æ•°éƒ½æœ‰è¯¦ç»†docstring
3. è¿è¡Œæµ‹è¯•ï¼š`python -m pytest tests/`

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2024-02-07
**ç»´æŠ¤è€…**ï¼šé‡åŒ–å›¢é˜Ÿ
**æœ€åæ›´æ–°**ï¼š2024-02-07
