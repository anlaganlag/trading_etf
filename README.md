# 📈 ETF 滚动轮动策略 (Rolling Rotation Strategy)

> **核心理念**: 滚动分仓 + 动态风险双门控 (Duo-Gate) + 最佳动量因子 (Momentum Alpha)

本策略不仅仅是一个简单的交易脚本，而是一个**具有自我保护能力的资金管理系统**。通过多层级的风险控制与实盘对齐逻辑，确保回测收益具有极高的实战参考价值。

---

## 📊 一、 核心机制与因果逻辑 (Core Mechanisms)

策略的每一个决策都建立在可解释的逻辑之上，通过“离散档位组合”将复杂的市场情绪量化为最终的“出价力度”。

### 1. 双门控风险系统 (Duo-Gate System)
两个系统在代码中是**乘法关系**，形成双重保险。

| 特性 | DYNAMIC_POSITION (趋势感应器) | ENABLE_META_GATE (崩盘急刹车) |
| :--- | :--- | :--- |
| **比喻** | 穿多穿少看“温度计” | 逃不逃跑看“地震仪” |
| **主要依据** | 均线 (MA120, MA20, MA60) | 短期波动统计感应 (Z-Score) |
| **主要作用** | **顺势而为**：在长牛中满仓，长熊中减速。 | **硬核防守**：防范突发性股灾/断头铡。 |
| **调节方式** | 线性阶梯 (0.3 -> 0.45 -> 0.9 -> 1.0) | 状态机开关 (1.0 -> 0.7 -> 0.0) |
| **反应速度** | 较慢，确认中长期趋势。 | 极快，感应短期非正常剧烈跌幅。 |

> **叠加效应**: `最终仓位系数 = 趋势感应系数 * 防御门系数`。只要任一系统喊“停车”，最终仓位即清零。

### 2. 滚动分仓 (Rolling Tranches)
*   **机制**: 资金分为 $N$ 份（默认10份），每天只操作 1/N。
*   **物理含义**: 极大地降低了“某一天买在最高点/卖在最低点”的择时运气成分。回测结果更接近数学期望值。

### 3. Z-Score 动态选股与剔除
*   **解法**: 使用 `Z-Score = (5日收益率) / (历史波动率)`。
*   **逻辑**: 只有当跌幅偏离常态超过 $K$ 倍标准差时，才判定为“结构损坏”并剥离。这有效区分了“正常波动”与“技术破位”。

---

## � 二、 收益阶段分析 (Return Evolution)

本策略的收益曲线具有高度的**状态依赖性 (State-Dependent)**：

1.  **🚀 积累期 (Accumulation)**:
    *   市场处于 `SAFE` 且趋势向上。100% 仓位运行，依靠 **20日动量** 捕捉主升浪。
2.  **🛡️ 减速期 (Deceleration)**:
    *   市场处于 `CAUTION` (坏树比例 > 40%)。风险系数降至 0.7，主动放弃部分收益换取安全，斜率变缓。
3.  **🛑 熔断期 (Hibernate)**:
    *   市场处于 `DANGER` (崩坏率 > 60%)。策略进入**0仓位休眠**，成功躲避如2024年初的极端行情。

---

## 🛠 三、 实盘一致性优化 (Live Trading Alignment)

为了消除“回测很丰满，实盘很骨感”的问题，策略针对实盘细节做了硬核对齐：

1.  **持仓自动对齐 (Reconcile)**:
    *   每日调仓前强制对比虚拟账本与券商真实持仓，消除因手动操作、废单或分红导致的“幽灵股份”。
2.  **严格规避碎股**:
    *   执行层强制执行 `int(vol / 100) * 100`，确保所有下单均为 100 股一手，规避 A 股实盘下单限制。
3.  **零未来函数防御**:
    *   **数据切片**: 仅允许策略看到 `current_dt` 之前的数据。
    *   **实时注入**: 实盘模式下实时获取最新 Tick 价注入矩阵，确保动量计算是“此时此刻”而非“昨日收盘”。
4.  **尾盘准实时决策**:
    *   每日 14:55 定时触发。此时行情基本定型，既有充足时间执行下单，又利用了当日最全信息。

---

## ⚙️ 四、 核心参数配置 (Parameters)

| 模块 | 参数名 | 当前值 | 物理含义 | 调整后果 |
| :--- | :--- | :--- | :--- | :--- |
| **规模** | `TOP_N` | **4** | 每日选取的强势标的数量 | 越小越集中(进攻强)；越大越平稳。 |
| **周期** | `PERIOD_T` | **10** | 持仓/滚动周期 | 决定反应快慢。值越小反应快但成本高。 |
| **评分** | `Momentum_20d` | **+150** | **趋势因子** (核心) | 权重越高，越倾向于追逐主升浪。 |
| **评分** | `Anti-Chase_3d` | **-70** | **反转/防追高因子** | 权重越负，越排斥短期涨短太快的标的。 |
| **风控** | `SAFE` 阈值 | **0.40** | 减仓警戒线 | 调低更敏感，但也更容易被洗出局。 |
| **风控** | `DANGER` 阈值 | **0.60** | 熔断清仓线 | 最后防线。超过此比例标的骨折则清仓。 |

---

## 🔬 五、 附录：技术细节 (Tech Specs)

### "坏树"（Broken）的数学定义
我们通过异常值检测来识别系统性风险：
1.  **定义“尺子”**: 采集 $T_{-65}$ 到 $T_{-5}$ 的历史下行波动率 $\sigma_{down}$。
2.  **识别“伤势”**: 计算最近 5 日跌幅的 Z 分数：
    $$ Z_{score} = \frac{R_{5d}}{\sigma_{down} \times \sqrt{5}} $$
3.  **判定**: 若 $Z < -2.5$，判定为“坏树”。
4.  **计算崩坏率 (BR)**: $BR = \text{坏树统计} / \text{全市场标的总量}$。

---

## 📝 六、 操作维护

### 每日检查 Checklist
1.  **14:55** 观察终端输出的 `Meta-Gate` 状态 (🟢 SAFE / � CAUTION / � DANGER)。
2.  检查 `rolling_state_simple.json` 是否正常更新，确保策略记忆完整。
3.  **常见问题**: 若大盘反弹但策略未动，通常是 `Hysteresis` (滞后保护) 在起作用，等待风险信号彻底解除。

---

## 🔬 七、 工程化迭代记录 (Engineering Optimization Log)

> **原则**: 每一次改进都必须满足 **工程化 + 可验证 + 抗过拟合 + 能落地**，拒绝"调参文学"。

### 2026-02-05 V3 迭代

#### ✅ 成功验证

| 改进项 | 描述 | 收益变化 | MaxDD | Sharpe | 结论 |
|--------|------|----------|-------|--------|------|
| **软冲销机制 (Turnover Buffer)** | 持仓在前 TOP_N + BUFFER 内不换手，减少无效震荡 | +1.85% | +1.00% | +0.05 | **必须保留** |

**软冲销机制原理**：
```
原逻辑（硬轮动）：排名从第4掉到第5 → 立即卖出，买入新第4名
新逻辑（软冲销）：排名从第4掉到第5 → 仍在缓冲区(前6名)内 → 不动，减少摩擦
```
实盘意义更大：节省印花税、佣金、冲击成本。

#### ⚠️ 条件有效

| 改进项 | 描述 | 回测结果 | 结论 |
|--------|------|----------|------|
| **新仓保护期** | 买入后 N 天内不触发止损 | 日线回测无差异 | 实盘中可能有效（分钟级止损场景） |
| **调仓时机优化** | 比较 10:30 vs 14:55 | 日线回测无差异 | 需要分钟数据验证 |

#### ❌ 已剔除

| 改进项 | 描述 | 结果 | 原因 |
|--------|------|------|------|
| **成交量确认** | 放量上涨标的加分 | 收益 -4.7% | ETF 的缩量上涨通常是健康信号，强制放量反而错失主升浪 |
| **动态止损 (ATR-Based)** | 根据波动率调整止损线 | 收益 -19.8% | ETF 波动率普遍较低，ATR*2.5 导致止损过紧，被过早震出局 |
| **动态 TOP_N** | 根据市场状态调整持仓数量 | 收益 -8.8% | SAFE 时持仓分散过度，无法充分享受主升浪 |

---

### 📊 当前最优配置

```python
# 核心参数
TOP_N = 4                    # 持仓数量 (固定)
REBALANCE_PERIOD_T = 10      # 滚动周期
TURNOVER_BUFFER = 2          # ⭐ 软冲销缓冲区 (唯一有效的工程改进)

# 风控开关
DYNAMIC_POSITION = True      # 趋势感应
ENABLE_META_GATE = True      # ⭐ 崩盘急刹车 (必须开启)

# 止损参数 (固定)
STOP_LOSS = 0.20             # 硬止损
TRAILING_TRIGGER = 0.15      # 移动止盈触发
TRAILING_DROP = 0.03         # 移动止盈回落

# 已关闭的实验性功能
DYNAMIC_STOP_LOSS = False    # 实验失败
DYNAMIC_TOP_N = False        # 实验失败
```

**回测基准 (2021-12-03 ~ 2026-01-23)**:
```
Return: 64.19% | MaxDD: 25.78% | Sharpe: 0.83
```

---

### 🗺️ 后续改进路线图

#### 已验证 (已入代码)

| 改进项 | 效果 | 状态 |
|--------|------|------|
| 软冲销机制 (Turnover Buffer) | +1.85% Return, +0.05 Sharpe | ✅ 生效 |

#### 无效 (已剔除)

| 改进项 | 效果 | 状态 |
|--------|------|------|
| 成交量确认 | -4.7% | ❌ 剔除 |
| 动态止损 (ATR) | -19.8% | ❌ 剔除 |
| 动态 TOP_N | -8.8% | ❌ 剔除 |

#### 待验证 (需要分钟数据/实盘)

#### 中期 (实盘打磨)

| 改进项 | 描述 |
|--------|------|
| 订单执行确认 | 下单后轮询状态，部分成交则补单 |
| 资金利用率监控 | 统计平均现金占比，识别闲置资金 |

---

## 📐 八、 设计哲学 (Design Philosophy)

### 1. 工程化 > 调参
> 调参只能在历史数据上"拟合"，工程化改进解决的是**执行层面的alpha损耗**。

### 2. 可验证 > 直觉
> 每一个改进都要有明确的对照组和验收标准。失败的实验和成功的实验同样有价值。

### 3. 抗过拟合 > 极致收益
> 宁可放弃 3% 的回测收益，也不引入没有因果逻辑支撑的"魔法参数"。

### 4. 代码即文档
> 所有逻辑都在 `main.py` 中严格定义。README 是对代码的解释，而非替代。

---

> **The Code is the Truth.**
> 所有逻辑均在 `main.py` 中严格定义，透明且可追溯。
