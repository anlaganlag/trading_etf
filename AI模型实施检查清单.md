# AI优化多周期选股模型 - 实施检查清单

## 项目概览
- **项目目标**：使用AI自动学习1-20天各周期的最优权重，选出未来20天确定性战胜指数的强势股
- **核心指标**：胜率≥70%，超额收益≥5%，最大回撤≤15%
- **预计工期**：11周（约3个月）

---

## 第一阶段：环境与数据准备（第1-3周）

### Week 1：环境搭建
- [ ] **任务1.1**：安装Python依赖
  ```bash
  pip install lightgbm xgboost optuna shap scikit-learn
  pip install pandas numpy matplotlib seaborn
  pip install mlflow joblib
  ```
  - 验证标准：运行 `python -c "import lightgbm; print(lightgbm.__version__)"` 成功

- [ ] **任务1.2**：创建项目目录结构
  ```bash
  mkdir -p models/trained_models
  mkdir -p data/processed data/raw
  mkdir -p evaluation/reports evaluation/plots
  mkdir -p notebooks
  ```
  - 验证标准：`ls -R` 显示完整目录树

- [ ] **任务1.3**：版本控制设置
  ```bash
  git checkout -b feature/ai-weight-optimization
  ```
  - 验证标准：在新分支上开发

### Week 2-3：数据收集
- [ ] **任务2.1**：实现多周期涨幅计算函数
  - 文件：`data/multi_period_data.py`
  - 函数：`calculate_period_gains(df, period_days)`
  - 测试：验证3日涨幅计算与手工计算一致
  - 验证标准：单元测试通过

- [ ] **任务2.2**：收集历史前100强势股数据
  - 时间范围：2020-01-01 至 2024-12-31
  - 数据格式：
    ```python
    {
        'date': datetime,
        'period_1': [('SZSE.159915', 0.032), ...],  # (symbol, gain)
        'period_2': [...],
        ...
        'period_20': [...]
    }
    ```
  - 验证标准：每个交易日都有20个周期的完整数据

- [ ] **任务2.3**：生成特征与标签
  - 特征：各周期排名（1-100）
  - 标签：未来20天是否跑赢指数、超额收益
  - 验证标准：
    - 样本量：约10万条（100股/天 × 1000交易日）
    - 标签分布：正负样本比例在30%-70%之间

- [ ] **任务2.4**：数据质量检查
  - [ ] 缺失值分析：缺失率 < 5%
  - [ ] 异常值检测：涨幅超过±30%的标记为异常
  - [ ] 生存偏差检查：包含退市股票数据
  - 验证标准：生成数据质量报告（data/processed/data_quality_report.txt）

---

## 第二阶段：模型开发（第4-7周）

### Week 4：基线模型
- [ ] **任务3.1**：实现等权重基线
  ```python
  baseline_weights = [1/20] * 20
  baseline_score = sum(rank_i * w_i for rank_i, w_i in zip(ranks, baseline_weights))
  ```
  - 验证标准：基线胜率 > 50%（随机猜测水平）

- [ ] **任务3.2**：实现当前策略基线
  - 权重：[0]*0 + [30]*1 + [0]*1 + [-70]*3 + [0]*15 + [150]*20
  - 验证标准：与当前生产策略结果一致

- [ ] **任务3.3**：基线性能报告
  - 指标：胜率、平均超额收益、夏普比率
  - 验证标准：文档记录在 `evaluation/reports/baseline_performance.md`

### Week 5-6：AI模型训练
- [ ] **任务4.1**：实现LightGBM模型
  - 文件：`models/weight_optimizer.py`
  - 类：`WeightOptimizer`
  - 验证标准：代码通过pylint检查，无语法错误

- [ ] **任务4.2**：划分训练/验证/测试集
  - 训练集：2020-01-01 至 2023-12-31（80%）
  - 验证集：2024-01-01 至 2024-06-30（10%）
  - 测试集：2024-07-01 至 2024-12-31（10%）
  - 验证标准：时间序列无泄露

- [ ] **任务4.3**：设计多目标损失函数
  ```python
  loss = 0.5 * classification_loss +  # 是否跑赢指数
         0.3 * ranking_loss +          # 排序质量
         0.2 * regression_loss         # 超额收益预测
  ```
  - 验证标准：损失函数可微、可优化

- [ ] **任务4.4**：训练初始模型
  ```bash
  python scripts/train_model.py --epochs 100 --early_stopping 20
  ```
  - 验证标准：
    - 训练集AUC > 0.70
    - 验证集AUC > 0.65
    - 无严重过拟合（train-val gap < 0.1）

- [ ] **任务4.5**：模型保存与版本管理
  ```python
  joblib.dump(model, 'models/trained_models/v1.0_20240207.pkl')
  ```
  - 验证标准：模型文件 < 50MB，加载时间 < 1s

### Week 7：超参数优化
- [ ] **任务5.1**：定义搜索空间
  ```python
  param_space = {
      'num_leaves': [15, 31, 63],
      'learning_rate': [0.01, 0.05, 0.1],
      'feature_fraction': [0.6, 0.8, 1.0],
      'lambda_l1': [0, 0.1, 0.5],
      'lambda_l2': [0, 0.1, 0.5]
  }
  ```

- [ ] **任务5.2**：运行Optuna优化
  ```bash
  python scripts/optimize_hyperparams.py --n_trials 100
  ```
  - 验证标准：找到验证集AUC > 0.70的参数组合

- [ ] **任务5.3**：分析特征重要性
  ```python
  shap_values = shap.TreeExplainer(model).shap_values(X_test)
  shap.summary_plot(shap_values, X_test, show=False)
  plt.savefig('evaluation/plots/shap_summary.png')
  ```
  - 验证标准：生成SHAP可视化图

- [ ] **任务5.4**：权重解释性分析
  - [ ] 哪些周期权重最高？（预期：10-20日长期动量）
  - [ ] 是否存在负权重？（预期：1-3日短期反转）
  - [ ] 权重是否稳定？（不同训练折权重波动 < 30%）
  - 验证标准：文档记录在 `evaluation/reports/weight_analysis.md`

---

## 第三阶段：回测与验证（第8-9周）

### Week 8：滚动窗口回测
- [ ] **任务6.1**：实现回测框架
  - 文件：`evaluation/backtester.py`
  - 功能：模拟真实交易流程
  - 验证标准：可重现性（相同输入产生相同输出）

- [ ] **任务6.2**：执行历史回测
  ```python
  backtester = Backtester(
      start_date='2022-01-01',
      end_date='2024-12-31',
      model_path='models/trained_models/best_model.pkl'
  )
  results = backtester.run()
  ```
  - 验证标准：
    - 胜率：≥ 70%
    - 超额收益：≥ 5%
    - 最大回撤：≤ 15%
    - 夏普比率：≥ 2.0

- [ ] **任务6.3**：对比实验
  | 策略 | 胜率 | 超额收益 | 夏普比率 | 最大回撤 |
  |-----|------|---------|---------|---------|
  | 等权重基线 | ? | ? | ? | ? |
  | 当前策略 | ? | ? | ? | ? |
  | AI优化（本次） | ? | ? | ? | ? |
  - 验证标准：AI策略在所有指标上不低于当前策略

- [ ] **任务6.4**：消融实验
  - [ ] 去除1-5日短期周期：性能变化？
  - [ ] 去除15-20日长期周期：性能变化？
  - [ ] 只使用前50名（而非前100名）：性能变化？
  - 验证标准：理解各组件贡献度

### Week 9：稳健性测试
- [ ] **任务7.1**：不同市场环境测试
  - 牛市期间（2020-2021）：回报率 vs 回撤
  - 熊市期间（2022）：防守能力
  - 震荡市（2023）：稳定性
  - 验证标准：各环境下夏普比率 > 1.5

- [ ] **任务7.2**：极端行情压力测试
  - 2020年3月暴跌：最大回撤 < 20%
  - 2021年2月高位震荡：胜率 > 60%
  - 验证标准：极端情况下不爆仓

- [ ] **任务7.3**：参数敏感性分析
  - TOP_N变化（50/100/150）：性能变化曲线
  - 持有周期变化（10/15/20天）：最优周期
  - 验证标准：参数微调不应导致性能崩溃

---

## 第四阶段：系统集成（第10周）

### Week 10：代码集成
- [ ] **任务8.1**：修改 `core/signal.py`
  ```python
  # 在文件顶部添加
  from core.ai_scorer import AIScorer

  # 修改 get_ranking 函数
  def get_ranking(context, current_dt, whitelist):
      if config.USE_AI_SCORING:
          ai_scorer = AIScorer(model_path=config.AI_MODEL_PATH)
          return ai_scorer.score_stocks(context, current_dt, whitelist)
      else:
          # 原有逻辑...
  ```
  - 验证标准：代码通过单元测试

- [ ] **任务8.2**：添加配置开关
  - 文件：`config.py`
  - 配置项：
    ```python
    USE_AI_SCORING = True
    AI_MODEL_PATH = 'models/trained_models/best_model.pkl'
    AI_FALLBACK_TO_TRADITIONAL = True  # AI失败时回退
    ```
  - 验证标准：可灵活切换AI/传统模式

- [ ] **任务8.3**：异常处理与日志
  ```python
  try:
      scores = ai_scorer.score_stocks(...)
  except Exception as e:
      logger.error(f"AI scoring failed: {e}")
      if config.AI_FALLBACK_TO_TRADITIONAL:
          scores = traditional_scoring(...)
  ```
  - 验证标准：AI失败不影响策略运行

- [ ] **任务8.4**：性能优化
  - [ ] 模型加载缓存（避免重复加载）
  - [ ] 特征计算批处理（100只股票并行）
  - [ ] 预测结果缓存（同一天重复调用）
  - 验证标准：单次评分耗时 < 5秒

---

## 第五阶段：实盘测试（第11周）

### Week 11：A/B测试
- [ ] **任务9.1**：设计A/B实验
  - 策略A（70%资金）：AI优化权重
  - 策略B（30%资金）：原有固定权重
  - 验证标准：资金隔离，独立记账

- [ ] **任务9.2**：小资金试运行
  - 初始金额：10万元（或1%总资金）
  - 观察周期：5个交易日
  - 验证标准：
    - 订单成功率 > 95%
    - 无系统错误
    - 实盘与回测偏差 < 5%

- [ ] **任务9.3**：每日监控仪表板
  - [ ] 实时持仓对比（AI vs 传统）
  - [ ] 每日收益对比
  - [ ] 风险指标监控
  - 验证标准：邮件/微信每日推送报告

- [ ] **任务9.4**：7日效果评估
  - 如果AI策略表现优于传统 ≥ 2%：
    - [ ] 逐步增加AI策略仓位至50%
    - [ ] 继续观察14天
  - 如果AI策略表现劣于传统：
    - [ ] 分析原因（数据/模型/市场环境）
    - [ ] 回退至传统策略
    - [ ] 记录教训，规划v2.0

---

## 第六阶段：持续优化（长期）

### 模型维护计划
- [ ] **任务10.1**：定期重训练
  - 频率：每季度（90天）
  - 触发条件：胜率连续7天 < 60%
  - 验证标准：新模型在验证集上优于旧模型

- [ ] **任务10.2**：在线学习（可选）
  - 增量更新：每周使用最新7天数据微调
  - 验证标准：模型权重平滑变化（无突变）

- [ ] **任务10.3**：监控与告警
  - [ ] 模型预测准确率下降 > 10%：告警
  - [ ] 最大回撤超过15%：自动降仓
  - [ ] API调用失败 > 3次：切换备用模型
  - 验证标准：告警触发后5分钟内人工介入

---

## 关键里程碑检查点

### Milestone 1（Week 3结束）：数据就绪
- [ ] 10万条样本数据已清洗完成
- [ ] 数据质量报告通过审核
- [ ] 特征/标签分布符合预期

### Milestone 2（Week 7结束）：模型达标
- [ ] 验证集AUC ≥ 0.70
- [ ] 权重可解释性通过团队评审
- [ ] 模型文件已版本管理

### Milestone 3（Week 9结束）：回测通过
- [ ] 胜率 ≥ 70%
- [ ] 超额收益 ≥ 5%
- [ ] 最大回撤 ≤ 15%
- [ ] 对比实验优于基线

### Milestone 4（Week 10结束）：代码集成
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] 性能测试达标（<5s/次）

### Milestone 5（Week 11结束）：实盘验证
- [ ] A/B测试7天无系统故障
- [ ] AI策略收益不低于传统策略
- [ ] 决策是否全面推广

---

## 风险预警清单

| 风险等级 | 风险项 | 监控指标 | 应对措施 |
|---------|--------|---------|---------|
| 🔴 高 | 模型严重过拟合 | 验证集AUC < 0.60 | 简化模型、增加正则化 |
| 🔴 高 | 实盘表现崩盘 | 连续3天亏损 > 5% | 立即切换传统策略 |
| 🟡 中 | 数据质量不足 | 缺失率 > 10% | 补充数据源、缩短回测期 |
| 🟡 中 | 计算性能瓶颈 | 评分耗时 > 10s | 模型压缩、特征降维 |
| 🟢 低 | 超参数不优 | 优化收益 < 1% | 扩大搜索空间、增加试验次数 |

---

## 资源需求

### 人力资源
- 数据工程师：0.5人月（数据收集与清洗）
- 算法工程师：2人月（模型开发与优化）
- 后端工程师：0.5人月（系统集成）
- 量化研究员：1人月（回测与验证）

### 计算资源
- CPU：16核以上（模型训练）
- 内存：32GB以上
- 存储：50GB（历史数据 + 模型文件）
- GPU：可选（加速训练，非必需）

### 工具与服务
- Python环境：3.8+
- 掘金量化API
- MLflow实验管理（可选）
- 云服务器（实盘部署）

---

## 成功标准

### 技术指标
- [x] 胜率 ≥ 70%
- [x] 平均超额收益 ≥ 5%
- [x] 信息比率 ≥ 1.5
- [x] 最大回撤 ≤ 15%
- [x] 夏普比率 ≥ 2.0

### 业务指标
- [x] 7日实盘测试收益 ≥ 传统策略
- [x] 系统稳定性 > 99%（无宕机）
- [x] 订单执行成功率 > 95%

### 可维护性
- [x] 代码文档完善（注释率 > 30%）
- [x] 单元测试覆盖率 > 80%
- [x] 模型可解释性通过评审

---

**文档版本**：v1.0
**创建日期**：2024-02-07
**适用人员**：项目经理、开发团队、量化研究员
**更新频率**：每周更新进度
