# 📈 ETF 滚动轮动策略 (Rolling Rotation Strategy)

> **核心理念**: 分散时间风险 (Time-Diversification) + 动态风险门控 (Meta-Gate) + 动量因子 (Momentum Alpha)

本策略不仅仅是一个简单的交易脚本，而是一个**具有自我保护能力的资金管理系统**。它通过“滚动分仓”平滑了择时运气，通过“Meta-Gate”识别系统性崩盘，通过“Z-Score”剔除结构性损坏的标的。

---

## 目录 (Table of Contents)

1. [📊 收益的逐步演进](#-1-收益的逐步演进-the-evolution-of-returns)
2. [🛠 核心机制与因果关系](#-2-核心机制与因果关系-causality)
3. [⚙️ 参数配置与结果对应表](#-3-参数配置与结果对应表-parameters--mapping)
4. [🔬 技术细节 (Tech Specs)](#-4-附录技术细节-tech-specs)
5. [📝 操作手册](#-5-操作手册)

---

## 📊 1. 收益的逐步演进 (The Evolution of Returns)

本策略的收益曲线并非线性增长，而是呈现出明显的**状态依赖性 (State-Dependent)**。这也是本策略“可解释性”的核心：

### 🚀 Phase 1: 积累期 (Accumulation)
*   **市场状态**: `SAFE` (Broken Ratio < 40%)
*   **策略行为**: 100% 仓位全速运转。
*   **收益特征**: 利用 **20日动量 (Weight=150)** 捕捉主升浪，利用 **1日表现 (Weight=30)** 增强爆发力。此时收益率通常跑赢指数，呈现高斜率增长。

### 🛡️ Phase 2: 减速期 (Deceleration)
*   **市场状态**: `CAUTION` (Broken Ratio 40% - 60%)
*   **策略行为**: 风险系数降至 **0.7**。
*   **收益特征**: 随着市场波动加剧，策略主动放弃部分潜在收益以换取安全。净值曲线斜率变缓，主要是为了防止在即将到来的下跌中回撤过大。此时策略如同“在大雨中减速行驶”。

### 🛑 Phase 3: 熔断期 (Hibernate)
*   **市场状态**: `DANGER` (Broken Ratio > 60%)
*   **策略行为**: **0% 仓位 (空仓)**。
*   **收益特征**: **净值曲线走平**。
    > 当市场发生系统性崩盘（如2022年、2024年初）时，指数大幅下跌，而本策略因触发 Meta-Gate 处于“休眠”状态，成功躲避暴跌。**不做，就是最好的做。**

---

## 🛠 2. 核心机制与因果关系 (Causality)

本策略的每一个结果，都能直接追溯到具体的参数与逻辑设计。

### A. Meta-Gate 风险状态机 (系统性风控)
*   **因 (Cause)**: 市场中下跌幅度超过临界值 (`Z-Score < -2.5`) 的 ETF 数量激增。
*   **果 (Effect)**: `Broken Ratio` 上升，触发 `risk_scaler` 降维打击 (1.0 -> 0.7 -> 0.0)。
*   **可解释性**: 不预测未来，只根据当下“森林里倒下的树木数量”来决定是继续伐木还是回家躲避。

### B. Z-Score 动态阈值 (波动率标准化)
*   **问题**: 跌 5% 对波动小的债基是灾难，对创业板指却是日常。
*   **解法**: 使用 `Z-Score = (收益率) / (历史波动率)`。
*   **参数**: `k_entry = 1.6`。
*   **含义**: 只有当跌幅偏离常态超过 1.6 倍标准差时（统计学上的大概率异常），才判定为“结构损坏”并剔除。这比固定止损更科学。

### C. 滚动分仓 (Rolling Tranches)
*   **机制**: 资金分为 10 份，每天只操作 1/10。
*   **收益重复性**: 极大地降低了“某一天买在最高点”的运气成分。回测结果更加稳定，接近数学期望值，而非单次赌博的结果。

---

## ⚙️ 3. 参数配置与结果对应表 (Parameters & Mapping)

以下参数直接决定了策略的性格与产出结果。修改前请知悉其物理含义。

| 模块 | 参数名 | 当前值 | 物理含义 (Explainability) | 调整后果 (Causality) |
| :--- | :--- | :--- | :--- | :--- |
| **选股** | `TOP_N` | **4** | 每日持仓数量 | 越小越集中，进攻性强但波动大；越大越像指数增强。 |
| **周期** | `REBALANCE_PERIOD_T` | **10** | 调仓/滚动周期 | 决定了“持仓惯性”。值越小反应越快但交易成本高；值越大越迟钝。 |
| **评分** | `periods_rule` (20日) | **+150** | **趋势因子** | 核心动力。权重越高，越倾向于买入已经走出来的强势股。 |
| **评分** | `periods_rule` (3日) | **-70** | **反转因子** | **防追高**。权重越负，越排斥短期涨幅过大的标的（防止接盘）。 |
| **风控** | `SAFE` ➜ `CAUTION` | **0.40** | 警戒阈值 | 市场坏树比例超过 40% 即减仓。调低此值会更敏感（更早跑），但也更容易被洗出去。 |
| **风控** | `CAUTION` ➜ `DANGER` | **0.60** | 熔断阈值 | 市场坏树比例超过 60% 即清仓。这是最后一道防线。 |
| **止损** | `STOP_LOSS` | **0.20** | 硬止损线 | 防止单标的归零风险。 |

---

## 🔬 4. 附录：技术细节 (Tech Specs)

### 4.1 "坏树"与崩坏率的数学定义 (Mathematical Logic)

这里的“坏树”并非主观判断，而是基于统计学的**异常值检测 (Outlier Detection)**。核心旨在区分“正常波动”与“结构性崩塌”。

#### 第一步：定义“尺子” (The Robust Ruler)
我们不使用当下的波动率（因为暴跌时波动率会变大，导致尺子失真），而是使用**暴跌前**的历史下行波动率。
*   **采样区间**: $T_{-65}$ 到 $T_{-5}$ (过去两个月，但剔除了最近5天)
*   **指标**: 下行波动率 $\sigma_{down}$ (Downside Deviation)，只计算下跌的日子，忽略上涨波动。

#### 第二步：识别“伤势” (Z-Score Diagnosis)
计算每只 ETF 最近 5 天的跌幅相对于其历史波动率的倍数：

$$ Z_{score} = \frac{R_{5d}}{\sigma_{down} \times \sqrt{5}} $$

**实例分析**:
*   **Case A**: 一只平时稳如泰山的**红利 ETF** 跌了 10%，Z 分数可能高达 **-4.0**。
    *   *判定*: 结构崩塌。不仅是跌，而是“异常地跌”。
*   **Case B**: 一只平时波动很大的**传媒 ETF** 跌了 10%，Z 分数可能只有 **-1.5**。
    *   *判定*: 正常回调。

**判定标准**:
*   如果 $Z < -2.5$ (即跌幅超过 2.5 倍标准差)，判定为 **“坏树” (Broken)**。
*   这意味着该标的发生了统计学上极小概率的崩塌。

#### 第三步：计算“森林崩坏率” (Broken Ratio)

$$ BR = \frac{\text{坏树数量 (Count of } Z < -2.5 \text{)}}{\text{白名单标的总数 (Total Universe)}} $$

#### 第四步：Meta-Gate 决策
*   **$BR < 40\%$**: 森林即使有少量树倒下，也是正常的优胜劣汰 -> **SAFE**。
*   **$BR > 60\%$**: 超过六成的树都在发生极小概率的崩塌，说明是地震或火灾（系统性风险） -> **DANGER**。

---

## 📝 5. 操作手册

### 每日检查清单 (Checklist)
1.  **14:55** 自动运行 `algo()`。
2.  检查控制台输出的 **Meta-Gate 状态**：
    *   `[SAFE]` 🟢 -> 正常交易。
    *   `[CAUTION]` 🟡 -> 观察是否减仓。
    *   `[DANGER]` 🔴 -> 确认是否已清仓。
3.  检查 `rolling_state_simple.json` 是否更新（这是策略的记忆体）。

### 常见问题 (FAQ)
*   **Q: 为什么大盘涨了，策略没买？**
    *   **A**: 检查 Meta-Gate 是否处于 `DANGER` 状态（可能是之前的恐慌情绪尚未消退，Hysteresis 滞后效应正在保护你不抄底在半山腰）。
*   **Q: 为什么明明是牛市，仓位却不满？**
    *   **A**: 检查 `MAX_PER_THEME`。可能强势股集中在同一个板块（如半导体），策略为了防止板块风险过载，限制了买入数量。

---

> **The Code is the Truth.**
> 所有逻辑均在 `main.py` 中严格定义，无黑箱，无主观判断。