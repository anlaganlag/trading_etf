# 📈 ETF 滚动轮动策略：用户操作与技术手册 (main.py)

欢迎使用本策略。本策略专为 ETF 设计，其核心理念是 **“分散时间、严控回撤、顺势而为”**。

---

## 🛠 第一章：资金管理 (10 个水桶滚动方案)

为了防止“一把梭”在错误的时间买入，策略将总本金平分为 **10 个独立的分仓 (Tranche)**。

### 📌 机制说明
假设你有 **100 万** 本金：
1.  **分桶**：策略自动将资金分为 10 份，每份 **10 万**。
2.  **滚动**：第 1 天操作第 1 桶，第 2 天操作第 2 桶……直到第 10 天操作第 10 桶。
3.  **循环**：第 11 天，回到第 1 桶进行“卖旧买新”。

> **优点**：即使市场突发剧烈波动，当天也只处理 10% 的资金，其余 90% 的资金由止损系统静态保护，有效降低调仓时的随机性风险。

---

## 🛡 第二章：本金保护 (多维风险防御)

### 1. 个体卫士 (Individual Guard)
每个分仓中的每只 ETF 都有独立的生存检查：
*   **硬止损**：若单只 ETF 从买入价下跌超过 **30%**，立即清仓。
*   **追踪止盈 (Trailing Stop)**：
    *   **激活门槛**：涨幅超过 **15%** 时开启。
    *   **回撤平仓**：激活后，若价格从最高点回落 **3%**，立即锁定利润。

### 2. 微观门控 (Z-Score Gate)
利用统计学 Z-Score 过滤“结构性损坏”的标的。
*   **逻辑**：如果某只 ETF 最近 5 天的跌幅相对于其历史波动水平过于极端（超过 1.6 倍标准差），即使其长期趋势向上，策略也会将其视为“内部骨折”，**禁止买入**。

---

## ⚡ 第三章：Meta-Gate 风险状态机

这是本策略的核心竞争力。它不关注个体，而是监控**整个市场的“崩坏率” (Broken Ratio)**。

### 📌 状态平滑与切换
策略将市场环境分为三个等级（类似红绿灯）：
-   🟢 **安全区 (SAFE)**：崩坏率 < 40%，市场环境健康，正常交易。
-   🟡 **警示区 (CAUTION)**：崩坏率 > 40%，市场波动加大，减慢买入节奏。
-   🔴 **危险区 (DANGER)**：崩坏率 > 60%，系统性崩盘可能爆发。
    -   **防御动作**：立即触发“系统急刹车”，停止所有买入，转入绝对防御状态。
    -   **恢复机制**：只有崩坏率重新回落至 30% 以下，才会解除禁令，防止在“死猫跳”中频繁进场。

---

## 📈 第四章：选股引擎 (评分机制)

策略每天在白名单中筛选表现最强的 **4 只** ETF。

### 🏆 评分权重表 (Weights)
| 指标 | 权重 | 核心逻辑 |
| :--- | :--- | :--- |
| **20日动量** | +150 | 捕捉中短期“主升浪”趋势 |
| **1日表现** | +30 | 捕捉当下的动能惯性 |
| **3日乖离扣分** | **-70** | **防追高设计**：过滤掉涨势过急、短期面临超买回调风险的标的 |

> **资金分配**：采用不等权配置，评分 **前 3** 的标的分配 **2 倍** 资金，第 4 名分配 **1 倍** 资金。

---

## 🕒 第五章：每日操作ガイド

作为用户，你只需在 **每个交易日的 14:55** 确保脚本运行。

1.  **14:55:00**：策略自动唤醒及数据诊断。
2.  **多重检查**：
    *   **宏观端**：检查 HS300 是否处于半年线（MA120）上方。
    *   **中观端**：Meta-Gate 判定当前市场风险等级。
    *   **微观端**：计算白名单标的的 Z-Score 与动量评分。
3.  **交易指令**：
    *   **卖出**：优先执行触发止损、止盈或滚动到期的卖单。
    *   **买入**：根据 Meta-Gate 额度限制，买入高分领头羊。

---

## 📘 附录 A：技术解密 — 什么是 Z-Score？

Z-Score 衡量的是一件事情 **“有多不正常”**。

### 🏠 生活化比喻
想象路边的一条车道：
*   **Z = 0**：车辆稳稳行驶在车道中心（平均值）。
*   **Z = ±1**：车辆略微偏离中心线，但在车道内，属于正常驾驶。
*   **Z = -1.6**：车辆的轮胎已经踩到了草坪，属于“不正常驾驶”。
*   **Z = -3**：车辆已经冲出了马路，发生翻车。

**策略逻辑**：一旦 ETF 的跌幅 Z-Score < -1.6，就意味着它正在经历一场“极不寻常的踩踏”，我们必须“跳车”或拒绝“上车”。

---

## 📘 附录 B：基准 (Benchmark) 使用说明

在 `gm_strategy_rolling0.py` 中，沪深 300 (SHSE.510300) 扮演着双重角色：

### 1. 宏观风控 (生效中)
*   **功能**：判断市场牛熊状态。
*   **位置**：`get_market_regime` 函数（约第 435 行）。
*   **逻辑**：若价格跌破 MA120，将启动控仓逻辑（减半或清仓）。

### 2. 超额收益评价 (可选)
*   **状态**：目前 `get_ranking` 默认使用 **绝对收益**。
*   **保留代码**：约第 657-733 行（V6.1 逻辑）包含了计算 `Alpha`（标的收益 - HS300 收益）的代码。
*   **切换建议**：如需将选股标准从“跑得快”改为“跑得赢大盘”，只需启用 V6.1 部分的 Alpha 评分逻辑。

---

## 📝 总结

`main.py` 不仅是一个下单工具，它是一个**具备防御本能的资管系统**。
它通过 **时间分散 (10桶)**、**个体过滤 (Z-Score)**、**系统熔断 (Meta-Gate)** 与 **动量反转评分**，构建了一个在各种市场环境下都能自主呼吸、自我保护的交易平台。

> **请关注**：确保脚本目录下存在 `.json` 状态文件，这是记录 10 个水分仓状态的“大脑”。